name: Run CppUTest and Release

on:
  push:
    branches:
      - "**"  # Trigger tests on any branch push
    tags:
      - "v*.*.*"  # Trigger release on tag push

env:
  APP_NAME: my_executable

permissions:
  contents: write

jobs:
  docker-unit-tests:
    runs-on: ubuntu-latest
    name: Build and run unit tests with docker image
    if: github.event_name == 'push'  # Runs for both branches and tags
    steps:
      - name: Check out this repo
        uses: actions/checkout@v3

      - name: Build docker image
        run: docker build -t unit-tests-image -f Dockerfile .

      - name: Run image
        run: docker run --rm unit-tests-image

  release:
    needs: docker-unit-tests
    runs-on: ubuntu-latest
    name: Create a release if CppUTests passed
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Check out this repo
        uses: actions/checkout@v3
      
      - name: Build docker image
        run: docker build -t release-image -f Dockerfile .
      
      - name: Run image
        run: docker run --name release-container release-image

      - name: Copy the ELF file from the Docker to the GitHub dir
        run: docker cp release-container:/project/${APP_NAME}.elf ./${APP_NAME}.elf

      - name: Put app name into env of GitHub env
        run: echo "app_name=$APP_NAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.app_name }}.elf
          body_path: CHANGELOG.md

